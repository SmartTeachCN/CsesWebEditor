<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/dev/style.css" />
  <link href="/assets/bootstrap-icons.css" rel="stylesheet" type="text/css" />
  <style>html,body{background:transparent}body{padding:0 12px 12px}.pageTitle{margin-left:0;margin-right:0;width:100%}</style>
  <script type="module">
    import {allComponents, provideFluentDesignSystem} from 'https://npm.elemecdn.com/@fluentui/web-components';
    provideFluentDesignSystem().register(allComponents);
  </script>
  <script>
    try { if (parent) parent.postMessage({ type: 'iframe-start' }, '*'); } catch {}
    (function(){
      try {
        var _ol = console.log; var _oe = console.error;
        console.log = function(){ try { var msg = Array.prototype.slice.call(arguments).join(' '); if (parent) parent.postMessage({ type: 'iframe-log', text: msg }, '*'); } catch {} try { _ol.apply(console, arguments); } catch {} };
        console.error = function(){ try { var msg = Array.prototype.slice.call(arguments).join(' '); if (parent) parent.postMessage({ type: 'iframe-log', text: msg }, '*'); } catch {} try { _oe.apply(console, arguments); } catch {} };
      } catch {}
    })();
  </script>
  <script src="/dev/scripts/storage.js" defer></script>
  <script type="module">
    import { baseLayerLuminance, StandardLuminance, allComponents, provideFluentDesignSystem } from 'https://npm.elemecdn.com/@fluentui/web-components';
    provideFluentDesignSystem().register(allComponents);
    try {
      const layer = document.body;
      const isDark = (()=>{ try { return !!(parent && parent.document && parent.document.body && parent.document.body.classList && parent.document.body.classList.contains('darkmode--activated')); } catch { return false } })();
      baseLayerLuminance.setValueFor(layer, isDark ? StandardLuminance.DarkMode : StandardLuminance.LightMode);
    } catch {}
  </script>
  <script>
    window.openOwnerSubModal = function(){ try{ if (parent && typeof parent.openOwnerSubModal === 'function') parent.openOwnerSubModal(); }catch{} };
    window.openSubPanel = function(){ try{ if (parent && typeof parent.openSubPanel === 'function') parent.openSubPanel(); }catch{} };
  </script>
</head>
<body>
<p class="pageTitle pageTitle_main">实例信息</p>
<p class="pageTitle" style="background-color: rgba(250, 0, 0, 0.1); padding: 10px; border-radius: 4px; height: auto;">
  <i class="bi bi-info-circle"></i>&nbsp;<b>提示:</b>&nbsp;使用CSES Cloud代表您同意将部分必要数据上传至CSES Cloud服务器
</p>
<h4>基本</h4>
<div class="settings-card">
  <i class="bi bi-info-circle"></i>
  <div class="left-section">
    <div class="title">实例组标识</div>
    <div class="description">在受支持的程序中选择实例组,此ID是唯一的</div>
  </div>
  <div class="right-section">
    <span style="user-select: text" class="directoryId"></span>
  </div>
</div>
<div class="settings-card">
  <i class="bi bi-bookmark"></i>
  <div class="left-section">
    <div class="title">实例标识符</div>
    <div class="description">在受支持的程序中选择实例的标识符</div>
  </div>
  <div class="right-section">
    <span class="configId" style="user-select: text"></span>
  </div>
</div>
<div class="settings-card">
  <i class="bi bi-link-45deg"></i>
  <div class="left-section">
    <div class="title">源文件地址</div>
    <div class="description">可以通过此链接访问此实例的完整配置</div>
  </div>
  <div class="right-section">
    <fluent-button class="icon-btn" onclick="copyUrl(this)"><i class="bi bi-clipboard icon-anim" style="font-size: 12px;"></i>复制</fluent-button>
    <span style="user-select: text; display: none" id="url2">https://cloud.smart-teach.cn/user/<span class="directoryId"></span>/<span class="configId"></span>.cses</span>
  </div>
<link rel="stylesheet" href="../../assets/cloud.css">
</div>
<h4>配置</h4>
<div class="settings-card">
  <i class="bi bi-code-slash"></i>
  <div class="left-section">
    <div class="title">实例类型</div>
    <div class="description">选择该实例要使用的配置类型</div>
  </div>
  <div class="right-section">
    <fluent-select id="output-mode" onchange="storage.outputSet()" title="选择导出格式">
      <fluent-option value="ci">ClassIsland静态集控</fluent-option>
      <fluent-option value="es">ExamSchedule</fluent-option>
      <fluent-option value="cy">通用CSES</fluent-option>
    </fluent-select>
  </div>
</div>

<h4>子用户</h4>
<div class="settings-card" data-skip-unsaved>
  <i class="bi bi-people"></i>
  <div class="left-section">
    <div class="title">实例子用户</div>
    <div class="description">为当前实例创建最多5个子用户，子用户使用实例组标识、用户名与密钥进行认证</div>
  </div>
  <div class="right-section">
    <fluent-button onclick="openOwnerSubModal()">管理子用户</fluent-button>
    <fluent-button onclick="openSubPanel()">打开子用户面板</fluent-button>
  </div>
  <div style="width:100%;margin-top:10px;display:none">
    <div id="subuser-list"></div>
  </div>
  
</div>

<div class="settings-card">
  <i class="bi bi-box-arrow-down"></i>
  <div class="left-section">
    <div class="title">部署实例</div>
    <div class="description">下载集控配置/启用在线展示软件</div>
  </div>
  <div class="right-section">
    <fluent-button id="config_preview" onclick="storage.preview()"><i class="bi bi-play-circle"
        style="font-size: 12px;margin: 0;margin-right: 5px;"></i>
      启用向导</fluent-button>
  </div>
</div>
<script>
  function copyUrl(btn){
    try{
      var icon = btn && btn.querySelector('i');
      var text = document.getElementById('url2')?.textContent || '';
      if (!text) return;
      try{
        var ok=false; const handler=(e)=>{try{e.clipboardData.setData('text/plain',text); e.preventDefault();}catch{}};
        document.addEventListener('copy', handler); ok=document.execCommand('copy'); document.removeEventListener('copy', handler);
        if (!ok && navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(text).then(()=>{ if(icon){ const prev=icon.className; icon.className='bi bi-check'; setTimeout(()=>{icon.className=prev;},600);} }); }
      }catch{}
    }catch{}
  }
</script>
<script>
  try { storage.init(); storage.initEnv(); } catch {}
  try { if (parent) parent.postMessage({ type: 'iframe-ready' }, '*'); } catch {}
  try {
    var did = localStorage.getItem('directoryId') || '';
    var tid = localStorage.getItem('currentTerminalId') || '';
    var dEls = document.querySelectorAll('.directoryId');
    dEls.forEach(function(el){ el.textContent = did; });
    var cEls = document.querySelectorAll('.configId');
    cEls.forEach(function(el){ el.textContent = tid; });
  } catch {}
</script>
</body>
</html>
<h4 style="display: none">空间共享</h4>
<div class="settings-card" style="display: none">
  <i class="bi bi-people"></i>
  <div class="left-section">
    <div class="title">加入其他空间</div>
    <div class="description">输入用户ID、目标实例ID及本地实例ID</div>
  </div>
  <div class="right-section">
    <fluent-text-field id="target-user" placeholder="用户ID"></fluent-text-field>
    <fluent-text-field id="target-terminal" placeholder="目标实例ID"></fluent-text-field>
    <fluent-text-field id="local-terminal" placeholder="本地实例ID"></fluent-text-field>
    <fluent-button onclick="joinSpace()">加入</fluent-button>
  </div>
</div>
<div class="settings-card" style="display: none">
  <i class="bi bi-share"></i>
  <div class="left-section">
    <div class="title">共享当前空间</div>
    <div class="description">启用后其他用户可加入此空间</div>
  </div>
  <div class="right-section">
    <fluent-switch id="share-switch" onchange="toggleShareSettings()"></fluent-switch>
  </div>
</div>
<div class="settings-card" id="share-mode-card" style="display: none">
  <i class="bi bi-shield-lock"></i>
  <div class="left-section">
    <div class="title">访问控制</div>
    <div class="description">选择加入空间的验证方式</div>
  </div>
  <div class="right-section">
    <fluent-select id="share-mode" onchange="toggleAuthMethod()">
      <fluent-option value="password">密码验证</fluent-option>
      <fluent-option value="whitelist">白名单</fluent-option>
    </fluent-select>
  </div>
</div>
<div class="settings-card" id="password-card" style="display: none">
  <i class="bi bi-key"></i>
  <div class="left-section">
    <div class="title">共享密码</div>
    <div class="description">设置其他用户加入时需要的密码</div>
  </div>
  <div class="right-section">
    <fluent-text-field type="password" id="share-password" placeholder="输入密码"></fluent-text-field>
  </div>
</div>
<div class="settings-card" id="whitelist-card" style="display: none">
  <i class="bi bi-person-check"></i>
  <div class="left-section">
    <div class="title">用户白名单</div>
    <div class="description">输入允许的用户ID，用逗号分隔</div>
  </div>
  <div class="right-section">
    <fluent-text-area id="share-whitelist" placeholder="用户ID列表"></fluent-text-area>
  </div>
</div>
<div class="settings-card" style="display: none">
  <div class="left-section"></div>
  <div class="right-section">
    <fluent-button appearance="accent" onclick="saveSpaceConfig()">
      保存空间设置
    </fluent-button>
  </div>
</div>

