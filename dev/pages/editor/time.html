<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/dev/style.css" />
  <link href="/assets/bootstrap-icons.css" rel="stylesheet" type="text/css" />
  <style>html,body{background:transparent}body{padding:0 12px 12px}.pageTitle{margin-left:0;margin-right:0;width:100%}</style>
  <script type="module">
    import {allComponents, provideFluentDesignSystem, baseLayerLuminance, StandardLuminance} from 'https://npm.elemecdn.com/@fluentui/web-components';
    provideFluentDesignSystem().register(allComponents);
    try {
      const layer = document.body;
      const isDark = (()=>{ try { return !!(parent && parent.document && parent.document.body && parent.document.body.classList && parent.document.body.classList.contains('darkmode--activated')); } catch { return false } })();
      baseLayerLuminance.setValueFor(layer, isDark ? StandardLuminance.DarkMode : StandardLuminance.LightMode);
    } catch {}
  </script>
  <script>
    try { if (parent) parent.postMessage({ type: 'iframe-start' }, '*'); } catch {}
    (function(){
      try {
        var _ol = console.log; var _oe = console.error;
        console.log = function(){ try { var msg = Array.prototype.slice.call(arguments).join(' '); if (parent) parent.postMessage({ type: 'iframe-log', text: msg }, '*'); } catch {} try { _ol.apply(console, arguments); } catch {} };
        console.error = function(){ try { var msg = Array.prototype.slice.call(arguments).join(' '); if (parent) parent.postMessage({ type: 'iframe-log', text: msg }, '*'); } catch {} try { _oe.apply(console, arguments); } catch {} };
      } catch {}
    })();
  </script>
  <script src="/assets/js-yaml.min.js"></script>
  <script src="/dev/scripts/storage.js" defer></script>
  <script src="/dev/scripts/schedule.js" defer></script>
  
</head>
<body>
<p class="pageTitle pageTitle_main">时间表编辑</p>

<div class="settings-card" id="card-schedule0">
  <i class="bi bi-calendar-day"></i>
  <div class="left-section">
    <div class="title">时间表名称</div>
    <div class="description">编辑或重命名当前时间表</div>
  </div>
  <div class="right-section">
    <fluent-text-field id="time-template-name" placeholder="请输入名称"></fluent-text-field>
  </div>
  </div>

<div class="settings-card" id="card-quick-time" style="margin-top:12px;">
  <i class="bi bi-speedometer2"></i>
  <div class="left-section">
    <div class="title">快速时长</div>
    <div class="description">设置课程/课间分钟数，新建课时将自动填充</div>
  </div>
  <div class="right-section" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <fluent-text-field id="quick-course-min" placeholder="课程分钟数" style="width:140px"></fluent-text-field>
    <fluent-text-field id="quick-break-min" placeholder="课间分钟数" style="width:140px"></fluent-text-field>
  </div>
  </div>

<br>

<span style="width:100%">
  <div id="time-rows" style="display:flex;flex-direction:column;gap:8px"></div>
  <fluent-button appearance="accent" id="add-time-row-btn">新建课时</fluent-button>
</span>

<br><br>

<span>
  <fluent-button appearance="accent" id="save-time-template-btn">保存</fluent-button>
  <fluent-button id="delete-time-template-btn" style="margin-left:8px">删除</fluent-button>
  <fluent-button id="export-time-template-btn" style="margin-left:8px">导出JSON</fluent-button>
  <!-- <fluent-button id="import-time-template-btn" style="margin-left:8px">导入JSON</fluent-button> -->
</span>

<script>
  (function(){
    console.log('editor:time start');
    const run = () => {
      try {
        if (!(window.storage && window.schedule)) { console.log('editor:time waiting libs'); setTimeout(run, 50); return; }
        storage.init(); storage.initEnv(); console.log('editor:time after storage.init');
        const p = new URLSearchParams(location.search); const name = p.get('timetable');
        if (name) { schedule.showTimeEditor(name, false); console.log('editor:time showTimeEditor by params', name); } else { console.log('editor:time no timetable param'); }
      } catch (e) { console.error('editor:time init error', e); }
    };
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', run); } else { run(); }
    try { if (parent) parent.postMessage({ type: 'iframe-ready' }, '*'); } catch {}
  })();
  (function initQuickFields(){
    try {
      const c = localStorage.getItem('quick-course-min');
      const b = localStorage.getItem('quick-break-min');
      if (c) document.getElementById('quick-course-min').value = c;
      if (b) document.getElementById('quick-break-min').value = b;
    } catch (e) { console.warn('恢复快速时长失败', e); }
  })();
  document.getElementById('quick-course-min')?.addEventListener('change', (e)=>{
    localStorage.setItem('quick-course-min', (e.target.value || '').trim());
  });
  document.getElementById('quick-break-min')?.addEventListener('change', (e)=>{
    localStorage.setItem('quick-break-min', (e.target.value || '').trim());
  });
  document.getElementById('add-time-row-btn')?.addEventListener('click', () => {
    if (window.schedule && typeof schedule.addTimeRow === 'function') schedule.addTimeRow();
  });
  document.getElementById('save-time-template-btn')?.addEventListener('click', () => {
    if (window.schedule && typeof schedule.saveTimeTemplate === 'function') schedule.saveTimeTemplate();
  });
  document.getElementById('delete-time-template-btn')?.addEventListener('click', () => {
    if (window.schedule && typeof schedule.deleteTimeTemplateInEditor === 'function') schedule.deleteTimeTemplateInEditor();
  });
  document.getElementById('export-time-template-btn')?.addEventListener('click', () => {
    if (window.schedule && typeof schedule.exportTimeTemplateJSON === 'function') schedule.exportTimeTemplateJSON();
  });
  document.getElementById('import-time-template-btn')?.addEventListener('click', () => {
    if (window.schedule && typeof schedule.importTimeTemplateJSONUI === 'function') schedule.importTimeTemplateJSONUI();
  });
</script>
</body>
</html>
