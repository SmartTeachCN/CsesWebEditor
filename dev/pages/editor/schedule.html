<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/dev/style.css" />
  <link href="/assets/bootstrap-icons.css" rel="stylesheet" type="text/css" />
  <style>html,body{background:transparent}body{padding:0 12px 12px}.pageTitle{margin-left:0;margin-right:0;width:100%}</style>
  <script type="module">
    import {allComponents, provideFluentDesignSystem, baseLayerLuminance, StandardLuminance} from 'https://npm.elemecdn.com/@fluentui/web-components';
    provideFluentDesignSystem().register(allComponents);
    try {
      const layer = document.body;
      const isDark = (()=>{ try { return !!(parent && parent.document && parent.document.body && parent.document.body.classList && parent.document.body.classList.contains('darkmode--activated')); } catch { return false } })();
      baseLayerLuminance.setValueFor(layer, isDark ? StandardLuminance.DarkMode : StandardLuminance.LightMode);
    } catch {}
  </script>
  <script>
    try { if (parent) parent.postMessage({ type: 'iframe-start' }, '*'); } catch {}
    (function(){
      try {
        var _ol = console.log; var _oe = console.error;
        console.log = function(){ try { var msg = Array.prototype.slice.call(arguments).join(' '); if (parent) parent.postMessage({ type: 'iframe-log', text: msg }, '*'); } catch {} try { _ol.apply(console, arguments); } catch {} };
        console.error = function(){ try { var msg = Array.prototype.slice.call(arguments).join(' '); if (parent) parent.postMessage({ type: 'iframe-log', text: msg }, '*'); } catch {} try { _oe.apply(console, arguments); } catch {} };
      } catch {}
    })();
  </script>
  <script src="/assets/js-yaml.min.js"></script>
  <script src="/dev/scripts/storage.js" defer></script>
  <script src="/dev/scripts/schedule.js" defer></script>
  <script src="/dev/scripts/subject.js" defer></script>
  
</head>
<body>
<p class="pageTitle pageTitle_main">课表编辑</p>
<div class="settings-card" id="card-schedule0">
  <i class="bi bi-calendar-day"></i>
  <div class="left-section">
    <div class="title">启用星期</div>
    <div class="description">选择此张课表的作用星期</div>
  </div>
  <div class="right-section">
    <fluent-select id="day-mode" onchange="schedule.save()">
      <fluent-option value="1">星期一</fluent-option>
      <fluent-option value="2">星期二</fluent-option>
      <fluent-option value="3">星期三</fluent-option>
      <fluent-option value="4">星期四</fluent-option>
      <fluent-option value="5">星期五</fluent-option>
      <fluent-option value="6">星期六</fluent-option>
      <fluent-option value="7">星期日</fluent-option>
    </fluent-select>
  </div>
</div>
<div class="settings-card" id="card-schedule1">
  <i class="bi bi-arrow-repeat"></i>
  <div class="left-section">
    <div class="title">轮周设定</div>
    <div class="description">设置该课表在哪些特定周使用</div>
  </div>
  <div class="right-section">
    <fluent-select id="week-mode" onchange="schedule.save()">
      <fluent-option value="odd">单周</fluent-option>
      <fluent-option value="even">双周</fluent-option>
      <fluent-option value="all">通用</fluent-option>
    </fluent-select>
  </div>
</div>
<div class="settings-card" id="card-schedule2">
  <i class="bi bi-calendar-range"></i>
  <div class="left-section">
    <div class="title">选择日期</div>
    <div class="description">为课表选择一个具体日期</div>
  </div>
  <div class="right-section">
    <fluent-text-field type="date" id="schedule-date" onchange="schedule.save()"
      style="width: 180px"></fluent-text-field>
  </div>
</div>
<div class="settings-card" id="card-timetable">
  <i class="bi bi-clock-history"></i>
  <div class="left-section">
    <div class="title">应用时间表</div>
    <div class="description">选择时间表并应用至当前课时，或保存为模板</div>
  </div>
  <div class="right-section">
    <span id="timetable-status" style="color:#666; margin-left:8px;">未选择</span>
    <fluent-select id="timetable-mode" onchange="schedule.applyTimetableFromSelect(this.value)"
      style="width: 180px"></fluent-select>
  </div>
</div>
<br />
<div class="editor-layout">
  <div class="editor-left">
    <span style="height: 300px; overflow-y: auto; display: block">
      <fluent-listbox id="class-list" style="width: 100%"></fluent-listbox>
    </span>

    <div class="class-controls">
      <fluent-button appearance="accent" id="add-class-btn" onclick="schedule.addClass()">
        + 添加课时
      </fluent-button>
      <fluent-select onchange="schedule.setSubject(this.value)" id="current-subject"
        style="width: 150px"></fluent-select>
      <fluent-button id="toggle-time-editor" onclick="schedule.toggleTimeEditor()">显示课时编辑器</fluent-button>
      <fluent-button id="del-class-btn" onclick="schedule.delClass()">删除当前</fluent-button>
      <input type="time" class="time-input" onchange="schedule.setTime(currentClassIndex)" />
      <input type="time" class="time-input" onchange="schedule.setTime(currentClassIndex)" />
    </div>
  </div>

  <div class="quick-add-panel">
    <h3>快速添加课程</h3>
    <br />
    <div class="subject-grid"></div>
  </div>
</div>
<fluent-button onclick="schedule.clone()" style="margin-top: 1rem; margin-left: 5px">
  克隆
</fluent-button>
<fluent-button appearance="accent" id="save-timetable-btn" onclick="schedule.createTimetableUI()">保存为时间表</fluent-button>
<script>
  (function(){
    console.log('editor:schedule start');
    const run = () => {
      try {
        if (!(window.storage && window.schedule)) { console.log('editor:schedule waiting libs'); setTimeout(run, 50); return; }
        storage.init(); storage.initEnv(); console.log('editor:schedule after storage.init');
        if (!window.__scheduleInitialized) { schedule.init(); window.__scheduleInitialized = true; console.log('editor:schedule schedule.init called'); }
        const params = new URLSearchParams(location.search);
        const sub = params.get('sub');
        const schIdx = parseInt(params.get('schedule'));
        if (sub === 'schedule' && !isNaN(schIdx)) { schedule.load(schIdx, false); console.log('editor:schedule schedule.load by params', schIdx); }
        else {
          if (Array.isArray(currentData.schedules) && currentData.schedules.length > 0) { schedule.load(0, false); console.log('editor:schedule schedule.load fallback 0'); }
          else { console.log('editor:schedule no schedules'); }
        }
      } catch (e) { console.error('editor:schedule init error', e); }
    };
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', run); } else { run(); }
  })();
  try { if (parent) parent.postMessage({ type: 'iframe-ready' }, '*'); } catch {}
</script>
</body>
</html>
